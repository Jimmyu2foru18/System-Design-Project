<!--
Authors: James McGuigan, Steven Foster
Description: Admin dashboard that:
- Manages user accounts and permissions
- Moderates recipe submissions
- Reviews support tickets and feedback
- Provides analytics and reporting tools
- Controls site content and settings
- Handles user communications
- Maintains site configuration
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Recspicy</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex flex-col bg-gray-100">
    <!-- Navigation Bar -->
    <nav id="nav-container"></nav>

    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">Admin Dashboard</h1>
                <span id="admin-name" class="text-gray-600"></span>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-gray-500 text-sm mb-1">Total Users</h3>
                    <p id="total-users" class="text-2xl font-bold">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-gray-500 text-sm mb-1">Total Recipes</h3>
                    <p id="total-recipes" class="text-2xl font-bold">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-gray-500 text-sm mb-1">Pending Approvals</h3>
                    <p id="pending-approvals" class="text-2xl font-bold">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-gray-500 text-sm mb-1">Active Users Today</h3>
                    <p id="active-users" class="text-2xl font-bold">-</p>
                </div>
            </div>

            <!-- Main Content Tabs -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="border-b">
                    <nav class="flex">
                        <button class="tab-button px-6 py-4 text-blue-600 border-b-2 border-blue-600" data-tab="recipes">
                            Recipe Management
                        </button>
                        <button class="tab-button px-6 py-4 text-gray-600 hover:text-gray-800" data-tab="users">
                            User Management
                        </button>
                        <button class="tab-button px-6 py-4 text-gray-600 hover:text-gray-800" data-tab="support">
                            Support & Feedback
                        </button>
                        <button class="tab-button px-6 py-4 text-gray-600 hover:text-gray-800" data-tab="reports">
                            Reports & Analytics
                        </button>
                        <button class="tab-button px-6 py-4 text-gray-600 hover:text-gray-800" data-tab="email">
                            Email Management
                        </button>
                    </nav>
                </div>

                <!-- Recipe Management Tab -->
                <div id="recipes-tab" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex gap-4">
                            <input type="text" 
                                   placeholder="Search recipes..." 
                                   class="p-2 border rounded-lg w-64">
                            <select class="p-2 border rounded-lg">
                                <option value="all">All Recipes</option>
                                <option value="pending">Pending Approval</option>
                                <option value="approved">Approved</option>
                                <option value="flagged">Flagged</option>
                            </select>
                        </div>
                        <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Bulk Approve
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        <input type="checkbox" class="select-all">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Author</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recipe-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Recipe rows will be placed here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- User Management Tab -->
                <div id="users-tab" class="tab-content hidden p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex gap-4">
                            <input type="text" 
                                   placeholder="Search users..." 
                                   class="p-2 border rounded-lg w-64">
                            <select class="p-2 border rounded-lg">
                                <option value="all">All Users</option>
                                <option value="active">Active</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Joined</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- User rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Support & Feedback Tab -->
                <div id="support-tab" class="tab-content hidden p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex gap-4">
                            <input type="text" 
                                   placeholder="Search tickets..." 
                                   class="p-2 border rounded-lg w-64">
                            <select class="p-2 border rounded-lg">
                                <option value="all">All Tickets</option>
                                <option value="open">Open</option>
                                <option value="in-progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                        <div class="flex gap-4">
                            <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                Export Report
                            </button>
                        </div>
                    </div>

                    <!-- Support Tickets -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4">Support Tickets</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="support-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Support tickets here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- User Feedback -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4">User Feedback</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Feedback Cards -->
                            <div id="feedback-container" class="space-y-4">
                                <!-- Feedback cards here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports-tab" class="tab-content hidden p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- User Growth Chart -->
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4">User Growth</h3>
                            <div class="h-64 bg-gray-100">
                                <!-- Chart here -->
                            </div>
                        </div>

                        <!-- Recipe Submissions Chart -->
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4">Recipe Submissions</h3>
                            <div class="h-64 bg-gray-100">
                                <!-- Chart here -->
                            </div>
                        </div>

                        <!-- Popular Categories -->
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4">Popular Categories</h3>
                            <div class="space-y-2">
                                <!-- Category stats here based on star ratings -->
                            </div>
                        </div>

                        <!-- System Health -->
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4">System Health</h3>
                            <div class="space-y-2">
                                <!-- System metrics, find out how to bild metrics and monitor system health likely installs with express -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Management Tab -->
                <div id="email-tab" class="tab-content hidden p-6">
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-semibold">Email Management</h2>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    onclick="openNewEmailModal()">
                                New Email
                            </button>
                        </div>

                        <!-- Email Templates -->
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4">Email Templates</h3>
                            <div id="email-templates" class="space-y-2">
                                <!-- Templates here -->
                            </div>
                        </div>

                        <!-- Recent Emails -->
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold mb-4">Recent Emails</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Recipients</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sent</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-emails">
                                        <!-- Recent emails here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div id="footer-container"></div>
	
    <script src="navigation.js"></script>
	
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // check if user is signed in
            const token = localStorage.getItem('userToken') || localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = 'signin.html';
                return;
            }
            
            initializeDashboard();
        });

        async function initializeDashboard() {
            // tab switching
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    
                    // Update button states
                    tabButtons.forEach(btn => {
                        btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                        btn.classList.add('text-gray-600');
                    });
                    button.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                    button.classList.remove('text-gray-600');

                    // Show selected tab
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(`${tabName}-tab`).classList.remove('hidden');

                    // Load tab data
                    loadTabData(tabName);
                });
            });

            // Loads the necessary data
            await loadDashboardStats();
            await loadTabData('recipes');
        }

        async function loadDashboardStats() {
            try {
                const stats = await AdminService.getDashboardStats();
                document.getElementById('total-users').textContent = stats.totalUsers;
                document.getElementById('total-recipes').textContent = stats.totalRecipes;
                document.getElementById('pending-approvals').textContent = stats.pendingApprovals;
                document.getElementById('active-users').textContent = stats.activeUsers;
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        async function loadTabData(tabName) {
            try {
                switch (tabName) {
                    case 'recipes':
                        const recipes = await AdminService.getRecipes();
                        populateRecipeTable(recipes);
                        break;
                    case 'users':
                        const users = await AdminService.getUsers();
                        populateUserTable(users);
                        break;
                    case 'reports':
                        await loadReportData();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${tabName} data:`, error);
            }
        }

        function populateRecipeTable(recipes) {
            const tableBody = document.getElementById('recipe-table-body');
            tableBody.innerHTML = recipes.map(recipe => `
                <tr>
                    <td class="px-6 py-4">
                        <input type="checkbox" value="${recipe._id}">
                    </td>
                    <td class="px-6 py-4">${recipe.title}</td>
                    <td class="px-6 py-4">${recipe.authorUsername}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-sm rounded-full ${getStatusClass(recipe.status)}">
                            ${recipe.status}
                        </span>
                    </td>
                    <td class="px-6 py-4">${new Date(recipe.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4">
                        <button onclick="viewRecipe('${recipe._id}')"
                                class="text-blue-600 hover:text-blue-800 mr-2">
                            View
                        </button>
                        <button onclick="deleteRecipe('${recipe._id}')"
                                class="text-red-600 hover:text-red-800">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function populateUserTable(users) {
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = users.map(user => `
                <tr>
                    <td class="px-6 py-4">${user.username}</td>
                    <td class="px-6 py-4">${user.email}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-sm rounded-full ${getUserStatusClass(user.status)}">
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-6 py-4">${new Date(user.joinedAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4">
                        <button onclick="editUser('${user._id}')"
                                class="text-blue-600 hover:text-blue-800 mr-2">
                            Edit
                        </button>
                        <button onclick="toggleUserStatus('${user._id}')"
                                class="text-red-600 hover:text-red-800">
                            ${user.status === 'active' ? 'Suspend' : 'Activate'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'approved': return 'bg-green-100 text-green-800';
                case 'flagged': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getUserStatusClass(status) {
            return status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        }

        async function viewRecipe(id) {
            window.location.href = `recipe.html?id=${id}&admin=true`;
        }

        async function deleteRecipe(id) {
            if (confirm('Are you sure you want to delete this recipe?')) {
                try {
                    await AdminService.deleteRecipe(id);
                    loadTabData('recipes');
                } catch (error) {
                    console.error('Error deleting recipe:', error);
                    alert('Failed to delete recipe');
                }
            }
        }

        async function editUser(id) {
            // user/edit page
        }

        async function toggleUserStatus(id) {
            try {
                await AdminService.toggleUserStatus(id);
                loadTabData('users');
            } catch (error) {
                console.error('Error toggling user status:', error);
                alert('Failed to update user status');
            }
        }

        // Recipe management
        async function updateRecipe(recipeId, data) {
            try {
                await RecipeService.updateRecipe(recipeId, data);
                // success
            } catch (error) {
                // error
            }
        }
    </script>
</body>
</html> 